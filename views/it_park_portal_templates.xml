<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Template pour la page d'accueil du portail client -->
    <template id="it_park_portal_home" name="IT Park Portal Home">
        <t t-call="portal.portal_layout">
            <div class="container py-3">
                <!-- Bandeau de bienvenue moderne -->
                <div class="card mb-4 border-0 shadow-lg">
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <div class="col-md-8">
                                <div class="p-4 p-md-5" style="background: linear-gradient(135deg, #2C3E50, #4CA1AF); color: white; border-radius: 5px 0 0 5px;">
                                    <h1 class="display-5 fw-bold">Bienvenue <t t-esc="user.partner_id.name"/> !</h1>
                                    <p class="lead">Votre espace de gestion du parc informatique personnalisé</p>
                                    <div class="d-flex flex-wrap mt-4">
                                        <div class="me-4 mb-2">
                                            <span class="badge bg-light text-dark p-2">
                                                <i class="fa fa-building me-2"></i><t t-esc="user.company_id.name"/>
                                            </span>
                                        </div>
                                        <t t-if="user.partner_id.email">
                                            <div class="me-4 mb-2">
                                                <span class="badge bg-light text-dark p-2">
                                                    <i class="fa fa-envelope me-2"></i><t t-esc="user.partner_id.email"/>
                                                </span>
                                            </div>
                                        </t>
                                        <t t-if="user.partner_id.phone">
                                            <div class="mb-2">
                                                <span class="badge bg-light text-dark p-2">
                                                    <i class="fa fa-phone me-2"></i><t t-esc="user.partner_id.phone"/>
                                                </span>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-center justify-content-center" style="background-color: #f8f9fa; border-radius: 0 5px 5px 0;">
                                <div class="text-center p-4">
                                    <t t-if="user.partner_id.image_1920">
                                        <img t-att-src="image_data_uri(user.partner_id.image_1920)" class="rounded-circle shadow border border-light border-3" 
                                             alt="Logo client" style="max-width: 150px; height: auto;"/>
                                    </t>
                                    <t t-else="">
                                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center mx-auto" 
                                             style="width: 150px; height: 150px; color: white; font-size: 64px;">
                                            <i class="fa fa-user-circle"></i>
                                        </div>
                                    </t>
                                    <h5 class="mt-3"><t t-esc="user.partner_id.name"/></h5>
                                    <p class="text-muted mb-0">Client IT</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vérification d'accès -->
                <t t-if="not env.user.partner_id.is_it_client_approved or not env.user.partner_id.is_it_contract_paid">
                    <div class="alert alert-warning">
                        <h4><i class="fa fa-exclamation-triangle"></i> Accès limité</h4>
                        <p>Vous n'avez pas encore accès complet au parc informatique. 
                            Veuillez compléter votre inscription et effectuer le paiement initial pour débloquer toutes les fonctionnalités.</p>
                        <a href="/web/it_service_request/new" class="btn btn-primary mt-2">
                            <i class="fa fa-unlock-alt"></i> Débloquer l'accès
                        </a>
                    </div>
                </t>
                <!-- Message de succès si accès complet + statistiques -->
                <t t-if="env.user.partner_id.is_it_client_approved and env.user.partner_id.is_it_contract_paid">
                    <div class="alert alert-success mb-4">
                        <h4><i class="fa fa-check-circle"></i> Accès complet</h4>
                        <p>Vous avez maintenant accès à toutes les fonctionnalités de votre parc informatique.</p>
                    </div>
                    
                    <!-- Résumé du compte client - Design moderne -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header border-0" style="background: linear-gradient(to right, #f8f9fa, #ffffff);">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 bg-primary p-2 rounded me-3">
                                    <i class="fa fa-chart-pie text-white"></i>
                                </div>
                                <h4 class="mb-0">Tableau de bord</h4>
                            </div>
                        </div>
                        <div class="card-body pb-0">
                            <div class="row">
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="card h-100 border-0 shadow-sm rounded-lg">
                                        <div class="card-body text-center p-3">
                                            <div class="d-inline-flex align-items-center justify-content-center bg-primary-subtle rounded-circle mb-3 p-3">
                                                <i class="fa fa-desktop fa-2x text-primary"></i>
                                            </div>
                                            <h3 class="display-6 fw-bold text-primary mb-0"><t t-esc="equipment_count if equipment_count is not None else '0'"/></h3>
                                            <p class="text-muted mb-0">Équipements</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="card h-100 border-0 shadow-sm rounded-lg">
                                        <div class="card-body text-center p-3">
                                            <div class="d-inline-flex align-items-center justify-content-center bg-success-subtle rounded-circle mb-3 p-3">
                                                <i class="fa fa-ticket-alt fa-2x text-success"></i>
                                            </div>
                                            <h3 class="display-6 fw-bold text-success mb-0"><t t-esc="ticket_count if ticket_count is not None else '0'"/></h3>
                                            <p class="text-muted mb-0">Tickets ouverts</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="card h-100 border-0 shadow-sm rounded-lg">
                                        <div class="card-body text-center p-3">
                                            <div class="d-inline-flex align-items-center justify-content-center bg-info-subtle rounded-circle mb-3 p-3">
                                                <i class="fa fa-file-contract fa-2x text-info"></i>
                                            </div>
                                            <h3 class="display-6 fw-bold text-info mb-0"><t t-esc="contract_count if contract_count is not None else '0'"/></h3>
                                            <p class="text-muted mb-0">Contrats actifs</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="card h-100 border-0 shadow-sm rounded-lg">
                                        <div class="card-body text-center p-3">
                                            <div class="d-inline-flex align-items-center justify-content-center bg-warning-subtle rounded-circle mb-3 p-3">
                                                <i class="fa fa-key fa-2x text-warning"></i>
                                            </div>
                                            <h3 class="display-6 fw-bold text-warning mb-0"><t t-esc="license_count if license_count is not None else '0'"/></h3>
                                            <p class="text-muted mb-0">Licences</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info border-0 shadow-sm mb-0 p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="fa fa-calendar-check fa-2x text-info"></i>
                                    </div>
                                    <div>
                                        <h5 class="alert-heading mb-1">Information sur votre contrat</h5>
                                        <p class="mb-0">Votre contrat a été activé le <strong><t t-esc="active_contracts[0].start_date if active_contracts else 'N/A'"/></strong>
                                            <t t-if="active_contracts and active_contracts[0].end_date">
                                                et expire le <strong><t t-esc="active_contracts[0].end_date"/></strong>
                                            </t>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Menu principal moderne avec effets -->
                <div class="row mb-5">
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card h-100 border-0 overflow-hidden shadow-lg" style="border-radius: 15px; transition: all 0.3s ease;">
                            <div class="position-relative">
                                <div class="card-img-top bg-primary text-white d-flex align-items-center justify-content-center" style="height: 100px; position: relative; overflow: hidden;">
                                    <div class="position-absolute w-100 h-100" style="background: linear-gradient(45deg, #4e73df, #6610f2); opacity: 0.9;"></div>
                                    <i class="fa fa-ticket-alt fa-4x position-absolute" style="opacity: 0.2; right: -20px; top: -20px;"></i>
                                    <div class="position-relative">
                                        <h4 class="mb-0 fw-bold">Tickets</h4>
                                    </div>
                                </div>
                                <span class="position-absolute badge bg-white text-primary fw-bold d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px; border-radius: 50%; top: -10px; right: 20px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <t t-esc="ticket_count if ticket_count is not None else '0'"/>
                                </span>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Créez et suivez vos tickets de support technique</p>
                                <div class="mt-4">
                                    <a href="/my/tickets_list" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm">
                                        <i class="fa fa-ticket-alt me-2"></i>Gérer mes tickets
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card h-100 border-0 overflow-hidden shadow-lg" style="border-radius: 15px; transition: all 0.3s ease;">
                            <div class="position-relative">
                                <div class="card-img-top bg-success text-white d-flex align-items-center justify-content-center" style="height: 100px; position: relative; overflow: hidden;">
                                    <div class="position-absolute w-100 h-100" style="background: linear-gradient(45deg, #1cc88a, #20c997); opacity: 0.9;"></div>
                                    <i class="fa fa-desktop fa-4x position-absolute" style="opacity: 0.2; right: -20px; top: -20px;"></i>
                                    <div class="position-relative">
                                        <h4 class="mb-0 fw-bold">Équipements</h4>
                                    </div>
                                </div>
                                <span class="position-absolute badge bg-white text-success fw-bold d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px; border-radius: 50%; top: -10px; right: 20px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <t t-esc="equipment_count if equipment_count is not None else '0'"/>
                                </span>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Consultez l'inventaire de votre parc informatique</p>
                                <div class="mt-4">
                                    <a href="/my/equipment" class="btn btn-success btn-lg rounded-pill px-4 shadow-sm">
                                        <i class="fa fa-desktop me-2"></i>Voir mon parc
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card h-100 border-0 overflow-hidden shadow-lg" style="border-radius: 15px; transition: all 0.3s ease;">
                            <div class="position-relative">
                                <div class="card-img-top bg-info text-white d-flex align-items-center justify-content-center" style="height: 100px; position: relative; overflow: hidden;">
                                    <div class="position-absolute w-100 h-100" style="background: linear-gradient(45deg, #36b9cc, #4fc3f7); opacity: 0.9;"></div>
                                    <i class="fa fa-file-contract fa-4x position-absolute" style="opacity: 0.2; right: -20px; top: -20px;"></i>
                                    <div class="position-relative">
                                        <h4 class="mb-0 fw-bold">Contrats</h4>
                                    </div>
                                </div>
                                <span class="position-absolute badge bg-white text-info fw-bold d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px; border-radius: 50%; top: -10px; right: 20px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <t t-esc="contract_count if contract_count is not None else '0'"/>
                                </span>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Suivez vos contrats de maintenance et services</p>
                                <div class="mt-4">
                                    <a href="/my/contracts" class="btn btn-info btn-lg rounded-pill px-4 shadow-sm">
                                        <i class="fa fa-file-contract me-2"></i>Voir mes contrats
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card h-100 border-0 overflow-hidden shadow-lg" style="border-radius: 15px; transition: all 0.3s ease;">
                            <div class="position-relative">
                                <div class="card-img-top bg-warning text-white d-flex align-items-center justify-content-center" style="height: 100px; position: relative; overflow: hidden;">
                                    <div class="position-absolute w-100 h-100" style="background: linear-gradient(45deg, #f6c23e, #ffc107); opacity: 0.9;"></div>
                                    <i class="fa fa-file-invoice-dollar fa-4x position-absolute" style="opacity: 0.2; right: -20px; top: -20px;"></i>
                                    <div class="position-relative">
                                        <h4 class="mb-0 fw-bold">Factures</h4>
                                    </div>
                                </div>
                                <span class="position-absolute badge bg-white text-warning fw-bold d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px; border-radius: 50%; top: -10px; right: 20px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <t t-esc="invoice_count if invoice_count is not None else '0'"/>
                                </span>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Consultez et gérez vos factures</p>
                                <div class="mt-4">
                                    <a href="/my/invoices" class="btn btn-warning btn-lg rounded-pill px-4 shadow-sm">
                                        <i class="fa fa-file-invoice me-2"></i>Voir mes factures
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nouvelle carte pour les sites clients -->
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card h-100 border-0 overflow-hidden shadow-lg" style="border-radius: 15px; transition: all 0.3s ease;">
                            <div class="position-relative">
                                <div class="card-img-top bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 100px; position: relative; overflow: hidden;">
                                    <div class="position-absolute w-100 h-100" style="background: linear-gradient(45deg, #5a5c69, #6c757d); opacity: 0.9;"></div>
                                    <i class="fa fa-building fa-4x position-absolute" style="opacity: 0.2; right: -20px; top: -20px;"></i>
                                    <div class="position-relative">
                                        <h4 class="mb-0 fw-bold">Sites</h4>
                                    </div>
                                </div>
                                <span class="position-absolute badge bg-white text-secondary fw-bold d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px; border-radius: 50%; top: -10px; right: 20px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <t t-esc="site_count if site_count is not None else '0'"/>
                                </span>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Gérez vos sites et localisations</p>
                                <div class="mt-4">
                                    <a href="/my/sites" class="btn btn-secondary btn-lg rounded-pill px-4 shadow-sm">
                                        <i class="fa fa-building me-2"></i>Voir mes sites
                                    </a>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <!-- Incidents récents -->
                <t t-if="has_it_access and recent_incidents">
                    <h3 class="mb-3"><i class="fa fa-bell"></i> Incidents récents</h3>
                    <div class="card mb-4">
                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Référence</th>
                                        <th>Description</th>
                                        <th>Date</th>
                                        <th>État</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="recent_incidents" t-as="incident">
                                        <tr>
                                            <td><t t-esc="incident.name"/></td>
                                            <td><t t-esc="incident.description"/></td>
                                            <td><t t-esc="incident.date_reported"/></td>
                                            <td>
                                                <span t-attf-class="badge badge-{{
                                                    'success' if incident.state == 'resolved'
                                                    else 'warning' if incident.state == 'in_progress'
                                                    else 'danger' if incident.state == 'blocked'
                                                    else 'info'
                                                }}">
                                                    <t t-esc="incident.state"/>
                                                </span>
                                            </td>
                                            <td>
                                                <a t-att-href="'/my/incidents/%s' % incident.id" class="btn btn-sm btn-outline-primary">
                                                    <i class="fa fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer text-end">
                            <a href="/my/incidents" class="btn btn-primary">Voir tous les incidents</a>
                        </div>
                    </div>
                </t>

                <!-- Contrats actifs -->
                <t t-if="has_it_access and active_contracts">
                    <h3 class="mb-3"><i class="fa fa-file-contract"></i> Contrats actifs</h3>
                            <div class="row">
                        <t t-foreach="active_contracts" t-as="contract">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="mb-0"><t t-esc="contract.name"/></h5>
                                                </div>
                                    <div class="card-body">
                                        <p><strong>Type:</strong> <t t-esc="contract.contract_type_id.name"/></p>
                                        <p><strong>Date fin:</strong> <t t-esc="contract.end_date"/></p>
                                        <p>
                                            <span t-attf-class="badge badge-{{
                                                'warning' if contract.state == 'expiring_soon'
                                                else 'success' if contract.state == 'active'
                                                else 'info'
                                            }}">
                                                <t t-esc="contract.state"/>
                                                        </span>
                                        </p>
                                                    </div>
                                    <div class="card-footer">
                                        <a t-att-href="'/my/contracts/%s' % contract.id" class="btn btn-sm btn-primary">
                                            Voir les détails
                                        </a>
                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                    <div class="text-end mb-4">
                        <a href="/my/contracts" class="btn btn-outline-primary">Voir tous les contrats</a>
                                    </div>
                                </t>

                <!-- Factures récentes -->
                <t t-if="has_it_access and recent_invoices">
                    <h3 class="mb-3"><i class="fa fa-file-invoice-dollar"></i> Factures récentes</h3>
                    <div class="card mb-4">
                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                    <thead>
                                    <tr>
                            <th>Référence</th>
                                        <th>Date</th>
                                        <th>Montant</th>
                            <th>État</th>
                                        <th></th>
                        </tr>
                    </thead>
                    <tbody>
                                    <t t-foreach="recent_invoices" t-as="invoice">
                                        <tr>
                                            <td><t t-esc="invoice.name"/></td>
                                            <td><t t-esc="invoice.invoice_date"/></td>
                                            <td><t t-esc="invoice.amount_total"/></td>
                                            <td>
                                                <span t-attf-class="badge badge-{{
                                                    'success' if invoice.payment_state == 'paid'
                                                    else 'warning' if invoice.payment_state == 'partial'
                                                    else 'danger' if invoice.payment_state == 'not_paid'
                                                    else 'info'
                                                }}">
                                                    <t t-esc="invoice.payment_state"/>
                                                </span>
                                            </td>
                                            <td>
                                                <a t-att-href="'/my/invoices/%s' % invoice.id" class="btn btn-sm btn-outline-primary">
                                                    <i class="fa fa-eye"></i>
                                                </a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                        </div>
                        <div class="card-footer text-end">
                            <a href="/my/invoices" class="btn btn-primary">Voir toutes les factures</a>
                        </div>
                    </div>
            </t>
            </div>
        </t>
    </template>

    <!-- Template pour l'affichage des contrats -->
    <template id="portal_my_contracts" name="My Contracts">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mes Contrats</t>
            </t>
            <t t-if="not contracts">
                <div class="alert alert-info text-center" role="alert">
                    Vous n'avez pas de contrats.
                </div>
            </t>
            <t t-if="contracts">
                <table class="table table-striped table-hover o_portal_my_doc_table">
                    <thead>
                        <tr class="active">
                            <th>Référence</th>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Date de début</th>
                            <th>Date de fin</th>
                            <th>État</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="contracts" t-as="contract">
                            <tr>
                                <td><t t-esc="contract.reference"/></td>
                                <td><t t-esc="contract.name"/></td>
                                <td><t t-esc="contract.contract_type_id.name"/></td>
                                <td><t t-esc="contract.start_date"/></td>
                                <td><t t-esc="contract.end_date"/></td>
                                <td>
                                    <t t-if="contract.state == 'draft'">
                                        <span class="badge badge-secondary">Brouillon</span>
                                    </t>
                                    <t t-if="contract.state == 'running'">
                                        <span class="badge badge-success">En cours</span>
                                    </t>
                                    <t t-if="contract.state == 'expired'">
                                        <span class="badge badge-danger">Expiré</span>
                                    </t>
                                    <t t-if="contract.state == 'canceled'">
                                        <span class="badge badge-dark">Annulé</span>
                                    </t>
                                </td>
                                <td class="text-end">
                                    <a t-att-href="'/my/contracts/%s' % contract.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </t>
        </t>
    </template>

    <!-- Template pour l'affichage détaillé d'un contrat -->
    <template id="portal_my_contract_detail" name="Contract Details">
        <t t-call="portal.portal_layout">
            <t t-set="o_portal_fullwidth_alert" groups="sales_team.group_sale_salesman">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url" t-value="'/web#model=it.contract&amp;id=%s&amp;view_type=form' % (contract.id)"/>
                </t>
            </t>

            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h3 class="mb-0"><t t-esc="contract.name"/></h3>
                            </div>
                            <div class="col-md-6 text-md-right">
                                <small class="text-muted">Référence: </small><span t-field="contract.reference"/>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-12 col-md-6">
                                <strong>Type de contrat:</strong> <span t-field="contract.contract_type_id.name"/>
                            </div>
                            <div class="col-12 col-md-6">
                                <strong>État:</strong>
                                <t t-if="contract.state == 'draft'">
                                    <span class="badge badge-secondary">Brouillon</span>
                                </t>
                                <t t-elif="contract.state == 'running'">
                                    <span class="badge badge-success">En cours</span>
                                </t>
                                <t t-elif="contract.state == 'expired'">
                                    <span class="badge badge-danger">Expiré</span>
                                </t>
                                <t t-elif="contract.state == 'canceled'">
                                    <span class="badge badge-dark">Annulé</span>
                                </t>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-12 col-md-6">
                                <strong>Date de début:</strong> <span t-field="contract.start_date"/>
                            </div>
                            <div class="col-12 col-md-6">
                                <strong>Date de fin:</strong> <span t-field="contract.end_date"/>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-12">
                                <strong>Notes:</strong> <span t-field="contract.notes"/>
                            </div>
                        </div>
                        
                        <!-- Factures associées au contrat -->
                        <div class="row mb-4" t-if="contract.invoice_ids">
                            <div class="col-12">
                                <h5>Factures associées</h5>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Référence</th>
                                            <th>Date</th>
                                            <th>Montant</th>
                                            <th>État</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="contract.invoice_ids" t-as="invoice">
                                            <tr>
                                                <td><span t-field="invoice.name"/></td>
                                                <td><span t-field="invoice.invoice_date"/></td>
                                                <td><span t-field="invoice.amount_total"/></td>
                                                <td>
                                                    <span t-if="invoice.payment_state == 'not_paid'" class="badge bg-warning">Non payée</span>
                                                    <span t-elif="invoice.payment_state == 'partial'" class="badge bg-info">Partiellement payée</span>
                                                    <span t-elif="invoice.payment_state == 'paid'" class="badge bg-success">Payée</span>
                                                    <span t-else="" class="badge bg-secondary">Autre</span>
                                                </td>
                                                <td>
                                                    <a t-att-href="'/my/invoices/%s' % invoice.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/my/contracts" class="btn btn-secondary">Retour aux contrats</a>
                        <a href="/my/invoices" class="btn btn-primary float-end">Voir mes factures</a>
                    </div>
                </div>

                <!-- Équipements couverts par le contrat -->
                <h4 class="mt-4">Équipements couverts</h4>
                <t t-if="not contract.equipment_ids">
                    <div class="alert alert-info text-center" role="alert">
                        Aucun équipement n'est couvert par ce contrat.
                    </div>
                </t>
                <t t-if="contract.equipment_ids">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr class="active">
                                <th>Référence</th>
                                <th>Équipement</th>
                                <th>Type</th>
                                <th>État</th>
                                <th>Site Client</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="contract.equipment_ids" t-as="item">
                                <tr>
                                    <td><t t-esc="item.reference"/></td>
                                    <td><t t-esc="item.name"/></td>
                                    <td><t t-esc="item.type_id.name"/></td>
                                    <td>
                                        <t t-if="item.state == 'draft'">
                                            <span class="badge badge-secondary">Brouillon</span>
                                        </t>
                                        <t t-if="item.state == 'in_stock'">
                                            <span class="badge badge-info">En stock</span>
                                        </t>
                                        <t t-if="item.state == 'installed'">
                                            <span class="badge badge-success">Installé</span>
                                        </t>
                                        <t t-if="item.state == 'maintenance'">
                                            <span class="badge badge-warning">En maintenance</span>
                                        </t>
                                        <t t-if="item.state == 'end_of_life'">
                                            <span class="badge badge-danger">Fin de vie</span>
                                        </t>
                                    </td>
                                    <td><span t-field="item.site_id.name"/></td>
                                    <td class="text-end">
                                        <a t-att-href="'/my/equipment/%s' % item.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
            </div>
        </t>
    </template>

    <!-- Template pour la redirection vers les détails du contrat -->
    <template id="portal_contract_detail" name="Contract Detail">
        <t t-call="it__park.portal_my_contract_detail"/>
    </template>

    <!-- Template pour les accès refusés au parc informatique -->
    <template id="portal_access_denied_detailed" name="IT Park Access Denied">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                        <div class="card">
                    <div class="card-header bg-warning">
                        <h3 class="card-title"><i class="fa fa-exclamation-triangle mr-2"></i> Accès refusé</h3>
                            </div>
                            <div class="card-body">
                        <div class="alert alert-warning" role="alert">
                            <p><t t-esc="error_message"/></p>
                            </div>
                        
                    <div class="mt-4">
                            <h4>Pour obtenir un accès au parc informatique :</h4>
                            <ol class="mt-3">
                                <li>Complétez votre profil client dans <a href="/my/home">votre espace personnel</a></li>
                                <li>Soumettez une demande de prestation IT via le bouton ci-dessous</li>
                                <li>Acceptez la proposition qui vous sera envoyée</li>
                                <li>Procédez au paiement pour activer votre accès</li>
                                    </ol>
                                </div>
                                
                        <!-- Ajouter un bouton pour créer une demande de service -->
                        <div class="text-center mt-4">
                            <a href="/web/it_service_request/new" class="btn btn-primary btn-lg">
                                <i class="fa fa-plus-circle mr-2"></i> Créer une demande de prestation
                                    </a>
                                </div>
                            </div>
                    <div class="card-footer">
                        <a href="/my/home" class="btn btn-secondary">
                            <i class="fa fa-arrow-left mr-2"></i> Retour à l'accueil
                        </a>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template pour la page de détail d'une facture -->
    <template id="portal_invoice_page" name="Invoice Details">
        <t t-call="portal.portal_layout">
            <div class="container py-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light py-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h3 class="mb-0 text-primary">Facture <span t-field="invoice.name"/></h3>
                                <p class="text-muted mb-0 mt-1" t-if="invoice.ref">Référence: <span t-field="invoice.ref"/></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span t-if="invoice.payment_state == 'not_paid'" class="badge bg-warning py-2 px-3">Non payée</span>
                                <span t-elif="invoice.payment_state == 'partial'" class="badge bg-info py-2 px-3">Partiellement payée</span>
                                <span t-elif="invoice.payment_state == 'paid'" class="badge bg-success py-2 px-3">Payée</span>
                                <span t-else="" class="badge bg-secondary py-2 px-3"><t t-esc="invoice.payment_state"/></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h5 class="mb-0"><i class="fa fa-info-circle me-2 text-primary"></i>Informations générales</h5>
                            </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th style="width: 40%">Client</th>
                                                <td><span t-field="invoice.partner_id.name"/></td>
                                            </tr>
                                            <tr>
                                                <th>Type</th>
                                                <td>
                                                    <t t-if="invoice.move_type == 'out_invoice'">Facture client</t>
                                                    <t t-elif="invoice.move_type == 'out_refund'">Avoir client</t>
                                                    <t t-elif="invoice.move_type == 'in_invoice'">Facture fournisseur</t>
                                                    <t t-elif="invoice.move_type == 'in_refund'">Avoir fournisseur</t>
                                                    <t t-else=""><span t-field="invoice.move_type"/></t>
                                                </td>
                                            </tr>
                                            <tr t-if="invoice.invoice_origin">
                                                <th>Origine</th>
                                                <td><span t-field="invoice.invoice_origin"/></td>
                                            </tr>
                                            <tr t-if="invoice.narration">
                                                <th>Note</th>
                                                <td><span t-field="invoice.narration"/></td>
                                            </tr>
                                        </table>
                            </div>
                        </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h5 class="mb-0"><i class="fa fa-calendar me-2 text-primary"></i>Informations de paiement</h5>
                            </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th style="width: 40%">Date de facturation</th>
                                                <td><span t-field="invoice.invoice_date"/></td>
                                            </tr>
                                            <tr t-if="invoice.invoice_date_due">
                                                <th>Date d'échéance</th>
                                                <td>
                                                    <span t-field="invoice.invoice_date_due"/>
                                                    <t t-if="invoice.payment_state == 'not_paid' and invoice.invoice_date_due &lt; datetime.date.today()">
                                                        <span class="badge bg-danger ms-2">En retard</span>
                                                    </t>
                                                </td>
                                            </tr>
                                            <tr t-if="invoice.invoice_payment_term_id">
                                                <th>Conditions de paiement</th>
                                                <td><span t-field="invoice.invoice_payment_term_id.name"/></td>
                                            </tr>
                                            <tr>
                                                <th>État du paiement</th>
                                                <td>
                                                    <span t-if="invoice.payment_state == 'not_paid'" class="text-warning">Non payée</span>
                                                    <span t-elif="invoice.payment_state == 'partial'" class="text-info">Partiellement payée</span>
                                                    <span t-elif="invoice.payment_state == 'paid'" class="text-success">Payée</span>
                                                    <span t-else="" class="text-secondary"><t t-esc="invoice.payment_state"/></span>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lignes de facture -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light py-2">
                                <h5 class="mb-0"><i class="fa fa-list me-2 text-primary"></i>Détails de la facture</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="bg-light">
                                <tr>
                                    <th>Produit</th>
                                    <th>Description</th>
                                    <th class="text-end">Quantité</th>
                                    <th class="text-end">Prix unitaire</th>
                                    <th class="text-end">Sous-total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="invoice.invoice_line_ids" t-as="line">
                                    <tr>
                                                    <td>
                                                        <span t-if="line.product_id" t-field="line.product_id.name"/>
                                                        <span t-else="">-</span>
                                                    </td>
                                        <td><span t-field="line.name"/></td>
                                        <td class="text-end"><span t-field="line.quantity"/></td>
                                        <td class="text-end"><span t-field="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></td>
                                        <td class="text-end"><span t-field="line.price_subtotal" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></td>
                                    </tr>
                                </t>
                            </tbody>
                                        <tfoot class="bg-light">
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="text-end"><strong>Sous-total</strong></td>
                                                <td class="text-end"><strong><span t-field="invoice.amount_untaxed" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></strong></td>
                                </tr>
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="text-end"><strong>Taxes</strong></td>
                                    <td class="text-end"><span t-field="invoice.amount_tax" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></td>
                                </tr>
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="text-end"><strong>Total</strong></td>
                                                <td class="text-end"><strong><span t-field="invoice.amount_total" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between py-3">
                        <a href="/my/invoices" class="btn btn-secondary">
                            <i class="fa fa-arrow-left me-1"></i>Retour aux factures
                        </a>
                        <div>
                        <!-- Bouton pour télécharger la facture -->
                            <a t-if="invoice.state == 'posted'" t-att-href="'/my/invoices/pdf/%s' % invoice.id" class="btn btn-outline-primary me-2">
                            <i class="fa fa-download me-1"></i>Télécharger
                        </a>
                        
                        <!-- Bouton de paiement (à implémenter selon les besoins) -->
                        <t t-if="invoice.state == 'posted' and invoice.payment_state != 'paid'">
                                <a href="#" class="btn btn-success">
                                <i class="fa fa-credit-card me-1"></i>Payer maintenant
                            </a>
                        </t>
                        </div>
                    </div>
                </div>
                
                <!-- Contrats liés à cette facture -->
                <t t-if="related_contracts">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light py-3">
                            <h4 class="mb-0"><i class="fa fa-file-contract me-2 text-primary"></i>Contrats associés</h4>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                    <tr>
                                        <th>Référence</th>
                                        <th>Nom</th>
                                        <th>Date de début</th>
                                        <th>Date de fin</th>
                                        <th>État</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="related_contracts" t-as="contract">
                                        <tr>
                                            <td><span t-field="contract.reference"/></td>
                                            <td><span t-field="contract.name"/></td>
                                            <td><span t-field="contract.start_date"/></td>
                                            <td><span t-field="contract.end_date"/></td>
                                            <td>
                                                    <span t-attf-class="badge bg-{{
                                                        'success' if contract.state == 'active'
                                                        else 'warning' if contract.state == 'expiring_soon'
                                                        else 'danger' if contract.state == 'expired'
                                                        else 'secondary'
                                                    }}">
                                                        <t t-esc="contract.state"/>
                                                    </span>
                                            </td>
                                            <td class="text-end">
                                                <a t-att-href="'/my/contracts/%s' % contract.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>
    
    <!-- Template pour la liste des factures -->
    <template id="portal_my_invoices" name="My Invoices">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mes Factures</t>
            </t>
            
            <t t-if="not invoices">
                <div class="alert alert-info text-center" role="alert">
                    Vous n'avez pas de factures.
                            </div>
            </t>
            
            <t t-if="invoices">
                <table class="table table-striped table-hover o_portal_my_doc_table">
                    <thead>
                        <tr class="active">
                            <th>Référence</th>
                            <th>Date</th>
                            <th>Échéance</th>
                            <th>Montant</th>
                            <th>État</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="invoices" t-as="invoice">
                            <tr>
                                <td><span t-field="invoice.name"/></td>
                                <td><span t-field="invoice.invoice_date"/></td>
                                <td><span t-field="invoice.invoice_date_due"/></td>
                                <td><span t-field="invoice.amount_total" t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/></td>
                                <td>
                                    <span t-if="invoice.payment_state == 'not_paid'" class="badge bg-warning">Non payée</span>
                                    <span t-elif="invoice.payment_state == 'partial'" class="badge bg-info">Partiellement payée</span>
                                    <span t-elif="invoice.payment_state == 'paid'" class="badge bg-success">Payée</span>
                                    <span t-else="" class="badge bg-secondary">Autre</span>
                                </td>
                                <td class="text-end">
                                    <a t-att-href="'/my/invoices/%s' % invoice.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div t-if="pager" class="o_portal_pager text-center">
                    <t t-call="portal.pager"/>
                                    </div>
                                </t>
        </t>
    </template>
    
    <!-- Template pour la liste des équipements -->
    <template id="portal_my_equipment" name="My Equipment">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mes Équipements</t>
            </t>
            
            <!-- Message informatif -->
            <div class="alert alert-info mb-4">
                <div class="d-flex">
                    <div class="flex-shrink-0 me-3">
                        <i class="fa fa-info-circle fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="alert-heading">Comment ajouter un équipement ?</h5>
                        <p class="mb-0">C'est habituellement votre prestataire IT qui gère l'ajout d'équipements. Vous devez lui faire une demande pour qu'il procède à l'ajout.</p>
                        <a href="/my/tickets/add" class="btn btn-primary mt-2">
                            <i class="fa fa-plus-circle me-1"></i> Faire une demande d'ajout d'équipement
                        </a>
                    </div>
                </div>
            </div>
            
            <t t-if="not equipment">
                <div class="alert alert-info text-center" role="alert">
                    Vous n'avez pas d'équipements enregistrés.
                                    </div>
        </t>
            
            <t t-if="equipment">
                <table class="table table-striped table-hover o_portal_my_doc_table">
                    <thead>
                        <tr class="active">
                            <th>Référence</th>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>État</th>
                            <th>Site Client</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="equipment" t-as="equip">
                            <tr>
                                <td><span t-field="equip.reference"/></td>
                                <td><span t-field="equip.name"/></td>
                                <td><span t-field="equip.type_id.name"/></td>
                                <td>
                                    <span t-if="equip.state == 'draft'" class="badge bg-secondary">Brouillon</span>
                                    <span t-elif="equip.state == 'in_stock'" class="badge bg-info">En stock</span>
                                    <span t-elif="equip.state == 'installed'" class="badge bg-success">Installé</span>
                                    <span t-elif="equip.state == 'maintenance'" class="badge bg-warning">En maintenance</span>
                                    <span t-elif="equip.state == 'end_of_life'" class="badge bg-danger">Fin de vie</span>
                                    <span t-else="" class="badge bg-secondary">Autre</span>
                                </td>
                                <td><span t-field="equip.site_id.name"/></td>
                                <td class="text-end">
                                    <a t-att-href="'/my/equipment/%s' % equip.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div t-if="pager" class="o_portal_pager text-center">
                    <t t-call="portal.pager"/>
                                    </div>
            </t>
        </t>
    </template>
    
    <!-- Template pour la liste des tickets de support -->
    <template id="it_support_ticket_list" name="Support Tickets">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mes Tickets</t>
            </t>
            
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <span></span>
                <a href="/my/tickets/add" class="btn btn-primary">
                    <i class="fa fa-plus"></i> Nouveau Ticket
                </a>
                                    </div>
                                    
            <t t-if="not tickets">
                <div class="alert alert-info text-center" role="alert">
                    Vous n'avez pas de tickets ouverts. Vous pouvez en créer un en cliquant sur le bouton "Nouveau Ticket".
            </div>
        </t>
            
            <t t-if="tickets">
                <table class="table table-striped table-hover o_portal_my_doc_table">
                    <thead>
                        <tr class="active">
                            <th>Référence</th>
                            <th>Sujet</th>
                            <th>Date de création</th>
                            <th>Priorité</th>
                            <th>État</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="tickets" t-as="ticket">
                            <tr t-attf-class="priority-#{ticket.priority}">
                                <td><span t-field="ticket.name"/></td>
                                <td><span t-field="ticket.subject"/></td>
                                <td><span t-field="ticket.create_date"/></td>
                                <td>
                                    <t t-if="ticket.priority == '0'">
                                        <span class="badge bg-info">Basse</span>
                                    </t>
                                    <t t-elif="ticket.priority == '1'">
                                        <span class="badge bg-success">Normale</span>
                                    </t>
                                    <t t-elif="ticket.priority == '2'">
                                        <span class="badge bg-warning">Élevée</span>
                                    </t>
                                    <t t-elif="ticket.priority == '3'">
                                        <span class="badge bg-danger">Critique</span>
                                    </t>
                                </td>
                                <td>
                                    <span t-if="ticket.stage_id.is_closed" class="badge bg-success">Fermé</span>
                                    <span t-else="" class="badge bg-primary">Ouvert</span>
                                </td>
                                <td class="text-end">
                                    <a t-att-href="'/my/tickets/%s' % ticket.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div t-if="pager" class="o_portal_pager text-center">
                    <t t-call="portal.pager"/>
            </div>
            </t>
        </t>
    </template>
    
    <!-- Template pour afficher les erreurs de demande de service -->
    <template id="service_request_error" name="Service Request Error">
        <t t-call="portal.portal_layout">
            <div class="container py-5">
                <div class="alert alert-danger">
                    <h3 class="alert-heading">Erreur</h3>
                    <p t-esc="error_message or 'Une erreur s'est produite lors du traitement de votre demande.'"/>
                </div>
                <div class="mt-4 text-center">
                    <a href="/web/it_service_request/new" class="btn btn-primary me-2">Réessayer</a>
                    <a href="/my/home" class="btn btn-secondary">Retour à l'accueil</a>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template pour le formulaire de demande de services -->
    <template id="it_service_request_form" name="IT Service Request Form">
        <t t-call="portal.portal_layout">
            <div class="container py-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Demande de services informatiques</h3>
                    </div>
                    <div class="card-body">
                        <p class="lead mb-4">Complétez le formulaire ci-dessous pour nous faire part de vos besoins en services informatiques.</p>

                        <form action="/web/it_service_request/submit" method="post" class="form-horizontal" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            
                            <!-- Informations sur l'entreprise -->
                            <h4 class="mt-3 mb-3">Informations sur votre entreprise</h4>
                            
                            <div class="form-group row mb-3">
                                <label class="col-md-3 col-form-label" for="company_size">Taille de l'entreprise</label>
                                <div class="col-md-9">
                                    <select class="form-select" id="company_size" name="company_size" required="required">
                                        <option value="small">Petite (1-10 employés)</option>
                                        <option value="medium">Moyenne (11-50 employés)</option>
                                        <option value="large">Grande (51-250 employés)</option>
                                        <option value="enterprise">Très grande (250+ employés)</option>
                                    </select>
                    </div>
                </div>
                
                            <div class="form-group row mb-3">
                                <label class="col-md-3 col-form-label" for="site_count">Nombre de sites</label>
                                <div class="col-md-9">
                                    <input type="number" class="form-control" id="site_count" name="site_count" min="1" value="1" required="required"/>
                            </div>
                        </div>
                            
                            <div class="form-group row mb-3">
                                <label class="col-md-3 col-form-label" for="employee_count">Nombre d'employés</label>
                                <div class="col-md-9">
                                    <input type="number" class="form-control" id="employee_count" name="employee_count" min="1" value="1" required="required"/>
                    </div>
                            </div>
                            
                            <!-- Services demandés -->
                            <h4 class="mt-4 mb-3">Services requis</h4>
                            
                            <div class="form-group mb-3">
                                <label>Sélectionnez les services dont vous avez besoin :</label>
                                <div class="row mt-2">
                                    <t t-foreach="service_types" t-as="service">
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" t-att-id="'service_' + service.code" 
                                                       t-att-value="service.code" name="services[]"/>
                                                <label class="form-check-label" t-att-for="'service_' + service.code">
                                                    <t t-esc="service.name"/>
                                                </label>
                        </div>
                    </div>
                                    </t>
                            </div>
                        </div>
                            
                            <!-- Informations complémentaires -->
                            <h4 class="mt-4 mb-3">Informations complémentaires</h4>
                            
                            <div class="form-group row mb-3">
                                <label class="col-md-3 col-form-label" for="expected_start_date">Date de début souhaitée</label>
                                <div class="col-md-9">
                                    <input type="date" class="form-control" id="expected_start_date" name="expected_start_date"/>
                    </div>
                </div>
                
                            <div class="form-group row mb-3">
                                <label class="col-md-3 col-form-label" for="description">Description de vos besoins</label>
                                <div class="col-md-9">
                                    <textarea class="form-control" id="description" name="description" rows="5" required="required" 
                                              placeholder="Décrivez vos besoins en services informatiques de manière détaillée..."></textarea>
                    </div>
                </div>
                        
                            <div class="mt-4 text-end">
                                <a href="/my/home" class="btn btn-secondary me-2">Annuler</a>
                                <button type="submit" class="btn btn-primary">Soumettre la demande</button>
            </div>
                        </form>
                </div>
                </div>
                </div>
        </t>
    </template>

    <!-- Template pour l'affichage détaillé d'une demande de service -->
    <template id="it_service_request_detail" name="Service Request Detail">
        <t t-call="portal.portal_layout">
            <div class="container py-3">
                <div class="card">
                    <div class="card-header">
                <div class="row">
                    <div class="col-md-6">
                                <h3 class="mb-0">Demande de service #<span t-field="service_request.name"/></h3>
                        </div>
                            <div class="col-md-6 text-md-end">
                                <span t-attf-class="badge bg-#{
                                    'success' if service_request.state == 'approved'
                                    else 'warning' if service_request.state == 'pending'
                                    else 'danger' if service_request.state == 'rejected'
                                    else 'info'}">
                                    <t t-field="service_request.state"/>
                                </span>
                    </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Informations de l'entreprise -->
                        <h4 class="mb-3">Informations de l'entreprise</h4>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <strong>Taille de l'entreprise:</strong>
                                <p t-field="service_request.company_size"/>
                </div>
                            <div class="col-md-4">
                                <strong>Nombre de sites:</strong>
                                <p t-field="service_request.site_count"/>
                </div>
                            <div class="col-md-4">
                                <strong>Nombre d'employés:</strong>
                                <p t-field="service_request.employee_count"/>
                </div>
                        </div>

                        <!-- Services demandés -->
                        <h4 class="mb-3">Services demandés</h4>
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Service</th>
                                                <th>Description</th>
                                                <th>État</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="service_request.service_line_ids" t-as="line">
                                                <tr>
                                                    <td><span t-field="line.service_type_id.name"/></td>
                                                    <td><span t-field="line.description"/></td>
                                                    <td>
                                                        <span t-attf-class="badge bg-#{
                                                            'success' if line.state == 'approved'
                                                            else 'warning' if line.state == 'pending'
                                                            else 'danger' if line.state == 'rejected'
                                                            else 'info'}">
                                                            <t t-field="line.state"/>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                    </div>
                </div>
            </div>

                        <!-- Informations complémentaires -->
                        <h4 class="mb-3">Informations complémentaires</h4>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <strong>Date de début souhaitée:</strong>
                                <p t-field="service_request.expected_start_date"/>
                            </div>
                            <div class="col-md-6">
                                <strong>Date de création:</strong>
                                <p t-field="service_request.create_date"/>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <strong>Description des besoins:</strong>
                                <p t-field="service_request.description"/>
                            </div>
                        </div>

                        <!-- Documents attachés -->
                        <t t-if="service_request.attachment_ids">
                            <h4 class="mb-3">Documents attachés</h4>
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="list-group">
                                        <t t-foreach="service_request.attachment_ids" t-as="attachment">
                                            <a t-att-href="'/web/content/%s?download=true' % attachment.id" 
                                               class="list-group-item list-group-item-action">
                                                <i class="fa fa-download me-2"></i>
                                                <t t-esc="attachment.name"/>
                                            </a>
                                        </t>
                                </div>
                            </div>
                        </div>
                        </t>
                    </div>
                    <div class="card-footer">
                        <a href="/my/service_requests" class="btn btn-secondary">
                            <i class="fa fa-arrow-left me-2"></i>Retour aux demandes
                        </a>
                        <t t-if="service_request.state == 'draft'">
                            <button class="btn btn-primary float-end" 
                                    t-att-data-request-id="service_request.id"
                                    onclick="submitServiceRequest(this)">
                                <i class="fa fa-paper-plane me-2"></i>Soumettre
                            </button>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour le formulaire de création de ticket -->
    <template id="portal_create_ticket" name="Create Ticket">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="text-center mb-4">Créer un nouveau ticket</h1>
                        
                        <form action="/my/tickets/submit" method="post" enctype="multipart/form-data" class="mt-4">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            
                            <div class="form-group mb-3">
                                <label for="name" class="form-label">Titre*</label>
                                <input type="text" class="form-control" name="name" required="required" 
                                       placeholder="Décrivez brièvement votre problème"/>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="category_id" class="form-label">Catégorie*</label>
                                <select class="form-select" name="category_id" required="required">
                                    <option value="">Sélectionnez une catégorie</option>
                                    <t t-foreach="categories" t-as="category">
                                        <option t-att-value="category.id">
                                            <t t-esc="category.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="priority" class="form-label">Priorité</label>
                                <select class="form-select" name="priority">
                                    <option value="0">Basse</option>
                                    <option value="1" selected="selected">Normale</option>
                                    <option value="2">Haute</option>
                                    <option value="3">Urgente</option>
                                </select>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="description" class="form-label">Description détaillée*</label>
                                <textarea class="form-control" name="description" rows="6" required="required"
                                          placeholder="Décrivez en détail votre problème..."></textarea>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="attachment" class="form-label">Pièce jointe</label>
                                <input type="file" class="form-control" name="attachment"/>
                                <small class="text-muted">Formats acceptés: PDF, PNG, JPG, JPEG, GIF</small>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <a href="/my/tickets" class="btn btn-secondary me-md-2">Annuler</a>
                                <button type="submit" class="btn btn-primary">Soumettre le ticket</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour la liste des tickets -->
    <template id="portal_tickets_list" name="My Support Tickets">
        <t t-call="portal.portal_layout">
            <!-- En-tête avec statistiques -->
            <div class="container py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2 mb-0">Mes tickets de support</h1>
                    <a href="/my/tickets/create" class="btn btn-primary">
                        <i class="fa fa-plus-circle me-2"></i>Nouveau ticket
                            </a>
                        </div>

                <!-- Cartes de statistiques -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge bg-primary p-3 rounded-circle">
                                            <i class="fa fa-ticket-alt fa-lg"></i>
                                        </span>
                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">Total tickets</h6>
                                        <h3 class="mb-0"><t t-esc="len(tickets)"/></h3>
                </div>
                                </div>
                                </div>
                            </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge bg-warning p-3 rounded-circle">
                                            <i class="fa fa-clock fa-lg"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">En attente</h6>
                                        <h3 class="mb-0"><t t-esc="tickets.filtered(lambda t: t.state == 'new')"/></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge bg-info p-3 rounded-circle">
                                            <i class="fa fa-spinner fa-lg"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">En cours</h6>
                                        <h3 class="mb-0"><t t-esc="tickets.filtered(lambda t: t.state == 'in_progress')"/></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge bg-success p-3 rounded-circle">
                                            <i class="fa fa-check-circle fa-lg"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">Résolus</h6>
                                        <h3 class="mb-0"><t t-esc="tickets.filtered(lambda t: t.state == 'done')"/></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des tickets -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">Liste des tickets</h5>
                            </div>
                            <div class="col-auto">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Rechercher un ticket..." 
                                           t-att-value="search" name="search"/>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                            <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                            <th>Référence</th>
                                        <th>Sujet</th>
                                            <th>Date</th>
                                        <th>Priorité</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="tickets" t-as="ticket">
                                            <tr>
                                            <td><span class="fw-bold" t-field="ticket.reference"/></td>
                                                <td><span t-field="ticket.name"/></td>
                                            <td><span t-field="ticket.create_date" t-options='{"widget": "date"}'/></td>
                                            <td>
                                                <span t-field="ticket.priority" class="badge"
                                                      t-attf-class="badge bg-#{'danger' if ticket.priority == 'high' 
                                                                               else 'warning' if ticket.priority == 'medium'
                                                                               else 'success'} rounded-pill">
                                                </span>
                                                </td>
                                            <td>
                                                <span t-field="ticket.state" class="badge"
                                                      t-attf-class="badge bg-#{'primary' if ticket.state == 'new'
                                                                               else 'info' if ticket.state == 'in_progress'
                                                                               else 'success' if ticket.state == 'done'
                                                                               else 'secondary'} rounded-pill">
                                                </span>
                                            </td>
                                                <td>
                                                <a t-attf-href="/my/tickets_detail/#{ticket.id}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fa fa-eye me-1"></i>Voir
                                                    </a>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                    </div>
                </div>

                            <!-- Pagination -->
                            <t t-call="portal.pager"/>
            </div>
        </t>
    </template>

    <!-- Template pour le détail d'un ticket -->
    <template id="portal_ticket_detail" name="Ticket Detail">
        <t t-call="portal.portal_layout">
            <div class="container py-4">
                <!-- En-tête avec actions -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="/my/home" class="text-decoration-none">Accueil</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="/my/tickets_list" class="text-decoration-none">Tickets</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    <t t-esc="ticket.name"/>
                                </li>
                            </ol>
                        </nav>
                        <h1 class="h2 mb-0 mt-2">
                            <span class="text-muted">#</span><t t-esc="ticket.name"/>
                        </h1>
                                    </div>
                    <div class="d-flex gap-2">
                        <button t-if="ticket.state != 'done'" class="btn btn-success" 
                                onclick="window.location.href='/my/tickets/close/' + ticket.id">
                            <i class="fa fa-check-circle me-2"></i>Marquer comme résolu
                        </button>
                        <a href="/my/tickets/edit/#{ticket.id}" class="btn btn-primary">
                            <i class="fa fa-edit me-2"></i>Modifier
                        </a>
                    </div>
                </div>

                <div class="row">
                    <!-- Informations principales -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="card-title mb-0">Détails du ticket</h5>
                                        <span t-field="ticket.state" class="badge"
                                          t-attf-class="badge bg-#{'primary' if ticket.state == 'new'
                                                                   else 'info' if ticket.state == 'in_progress'
                                                                   else 'success' if ticket.state == 'done'
                                                                   else 'secondary'} rounded-pill px-3 py-2">
                                        </span>
                                    </div>
                                
                                <div class="mb-4">
                                    <h3 class="h4 mb-3"><t t-esc="ticket.name"/></h3>
                                    <div class="bg-light rounded p-3">
                                        <p class="text-muted mb-0" t-field="ticket.description"/>
                                </div>
                            </div>

                                <div class="border-top pt-3">
                                    <div class="row g-3">
                                    <div class="col-md-6">
                                            <p class="mb-1 text-muted">Date de création</p>
                                            <p class="mb-0 fw-bold">
                                                <i class="fa fa-calendar-alt me-2 text-primary"></i>
                                                <span t-field="ticket.create_date"/>
                                            </p>
                                    </div>
                                    <div class="col-md-6">
                                            <p class="mb-1 text-muted">Dernière mise à jour</p>
                                            <p class="mb-0 fw-bold">
                                                <i class="fa fa-clock me-2 text-primary"></i>
                                                <span t-field="ticket.write_date"/>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1 text-muted">Priorité</p>
                                            <p class="mb-0">
                                                <span t-field="ticket.priority" class="badge"
                                                      t-attf-class="badge bg-#{'danger' if ticket.priority == 'high' 
                                                                               else 'warning' if ticket.priority == 'medium'
                                                                               else 'success'} rounded-pill px-3">
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1 text-muted">Assigné à</p>
                                            <p class="mb-0 fw-bold">
                                                <i class="fa fa-user me-2 text-primary"></i>
                                                <span t-field="ticket.user_id"/>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                    </div>
                                </div>
                                
                        <!-- Section des messages -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Messages et activités</h5>
                                <div class="messages-container">
                                    <t t-foreach="messages" t-as="message">
                                        <div class="message-item mb-4">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0">
                                                    <img t-if="message.author_id.image_128" 
                                                         t-att-src="image_data_uri(message.author_id.image_128)"
                                                         class="rounded-circle" width="40" height="40" 
                                                         alt="Profile"/>
                                                    <div t-else="" class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                                         style="width: 40px; height: 40px;">
                                                        <i class="fa fa-user"></i>
                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">
                                                            <span t-field="message.author_id"/>
                                                            <small class="text-muted ms-2">
                                                                <i class="fa fa-clock me-1"></i>
                                                                <span t-field="message.date"/>
                                                            </small>
                                                        </h6>
                                                    </div>
                                                    <div class="message-content mt-2">
                                                        <div class="mb-0" t-field="message.body"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                                
                                <!-- Formulaire de réponse amélioré -->
                                <form action="/my/tickets_detail/#{ticket.id}/comment" method="POST" class="mt-4">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <div class="form-group">
                                        <label for="comment" class="form-label fw-bold">Ajouter un commentaire</label>
                                        <textarea name="comment" id="comment" class="form-control" rows="4" 
                                                  placeholder="Écrivez votre message ici..."></textarea>
                                    </div>
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-paper-plane me-2"></i>Envoyer
                                        </button>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Barre latérale -->
                    <div class="col-lg-4">
                        <!-- Équipement lié -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Équipement concerné</h5>
                                <t t-if="ticket.equipment_id">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="badge bg-primary p-2 rounded">
                                                <i class="fa fa-desktop fa-lg"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1"><span t-field="ticket.equipment_id.name"/></h6>
                                            <p class="text-muted small mb-0">
                                                <span t-field="ticket.equipment_id.type_id.name"/>
                                            </p>
                                        </div>
                                    </div>
                                </t>
                                <t t-else="">
                                    <p class="text-muted mb-0">Aucun équipement associé</p>
                                </t>
                            </div>
                        </div>

                        <!-- Documents attachés -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Documents attachés</h5>
                                <t t-if="ticket.attachment_ids">
                                    <div class="list-group list-group-flush">
                                        <t t-foreach="ticket.attachment_ids" t-as="attachment">
                                            <a t-att-href="'/web/content/%s?download=true' % attachment.id"
                                               class="list-group-item list-group-item-action d-flex align-items-center">
                                                <i class="fa fa-file me-3 text-primary"></i>
                                                <div>
                                                    <h6 class="mb-0"><t t-esc="attachment.name"/></h6>
                                                    <small class="text-muted">
                                                        <t t-esc="attachment.file_size"/> KB
                                                    </small>
                                                </div>
                                            </a>
                                        </t>
                                    </div>
                                </t>
                                <t t-else="">
                                    <p class="text-muted mb-0">Aucun document attaché</p>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour la simulation de paiement des demandes de service -->
    <template id="it_service_request_payment_simulation" name="Service Request Payment Simulation">
        <t t-call="portal.portal_layout">
            <div class="container py-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Simulation de paiement</h3>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" t-attf-style="width: #{progress_step}%;" 
                                 t-attf-aria-valuenow="#{progress_step}" aria-valuemin="0" aria-valuemax="100">
                                <t t-esc="progress_text"/>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header">
                                        <h4 class="my-0">Récapitulatif de votre commande</h4>
                                    </div>
                                    <div class="card-body">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Service</th>
                                                    <th>Prix</th>
                                                    <th>Quantité</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="service_request.services_needed" t-as="service">
                                                    <tr>
                                                        <td><t t-esc="service.name"/></td>
                                                        <td>
                                                            <t t-if="service.has_fixed_price">
                                                                <span t-field="service.fixed_price" t-options='{"widget": "monetary", "display_currency": service.currency_id}'/>
                                                            </t>
                                                            <t t-if="service.has_user_price">
                                                                <div><span t-field="service.price_per_user" t-options='{"widget": "monetary", "display_currency": service.currency_id}'/> / utilisateur</div>
                                                            </t>
                                                            <t t-if="service.has_equipment_price">
                                                                <div><span t-field="service.price_per_equipment" t-options='{"widget": "monetary", "display_currency": service.currency_id}'/> / équipement</div>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-if="service.has_user_price">
                                                                <div><t t-esc="service_request.employee_count"/> utilisateurs</div>
                                                            </t>
                                                            <t t-if="service.has_equipment_price">
                                                                <div><t t-esc="service_request.employee_count"/> équipements (estimé)</div>
                                                            </t>
                                                        </td>
                                                        <td class="text-end">
                                                            <t t-set="service_total" t-value="0"/>
                                                            <t t-if="service.has_fixed_price" t-set="service_total" t-value="service_total + service.fixed_price"/>
                                                            <t t-if="service.has_user_price" t-set="service_total" t-value="service_total + (service.price_per_user * service_request.employee_count)"/>
                                                            <t t-if="service.has_equipment_price" t-set="service_total" t-value="service_total + (service.price_per_equipment * service_request.employee_count)"/>
                                                            <span t-esc="service_total" t-options='{"widget": "monetary", "display_currency": service.currency_id}'/>
                                                        </td>
                                                    </tr>
                                                </t>
                                                <tr class="table-active">
                                                    <th colspan="3" class="text-end">Total:</th>
                                                    <th class="text-end"><span t-field="service_request.total_amount" t-options='{"widget": "monetary", "display_currency": request.env.company.currency_id}'/></th>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header">
                                        <h4 class="my-0">Méthode de paiement</h4>
                                    </div>
                                    <div class="card-body">
                                        <form t-attf-action="/web/it_service_request/#{service_request.id}/simulate_payment" method="post" class="form-horizontal">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked="checked"/>
                                                <label class="form-check-label" for="credit_card">
                                                    Carte de crédit
                                                </label>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="payment_method" id="transfer" value="transfer"/>
                                                <label class="form-check-label" for="transfer">
                                                    Virement bancaire
                                                </label>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <small>Ceci est une simulation de paiement à des fins de démonstration. Aucun paiement réel ne sera effectué.</small>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">Payer maintenant</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour la confirmation de paiement -->
    <template id="it_service_request_payment_confirmation" name="Service Request Payment Confirmation">
        <t t-call="portal.portal_layout">
            <div class="container py-3">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0">Paiement confirmé</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="progress mb-4">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%" 
                                 aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                Paiement effectué
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <i class="fa fa-check-circle text-success" style="font-size: 5rem;"></i>
                        </div>
                        
                        <h2 class="mb-4">Votre paiement a été traité avec succès !</h2>
                        
                        <div class="alert alert-success mb-4">
                            <h4><i class="fa fa-unlock-alt me-2"></i> Accès complet débloqué !</h4>
                            <p class="mb-0">Vous avez maintenant accès à toutes les fonctionnalités de votre parc informatique. Vous pouvez désormais gérer vos équipements, suivre vos tickets, consulter vos contrats et bien plus encore.</p>
                        </div>
                        
                        <p class="lead">Votre contrat a été créé automatiquement et notre équipe vous contactera prochainement pour planifier la mise en place des services.</p>
                        
                        <div class="alert alert-info mt-4">
                            <strong>Référence de la commande:</strong> <span t-field="service_request.name"/>
                        </div>
                        
                        <div class="mt-4">
                            <a href="/my/home" class="btn btn-primary btn-lg">
                                <i class="fa fa-home me-2"></i>Accéder à votre espace client
                            </a>
                            <a t-attf-href="/my/contracts/#{service_request.contract_id.id}" t-if="service_request.contract_id" class="btn btn-outline-primary btn-lg ms-2">
                                <i class="fa fa-file-contract me-2"></i>Voir le contrat
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Fonctionnalités débloquées -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Fonctionnalités disponibles</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fa fa-desktop fa-2x text-success me-3"></i>
                                    </div>
                                    <div>
                                        <h4>Gestion des équipements</h4>
                                        <p>Consultez et gérez l'ensemble de votre parc informatique, incluant les ordinateurs, serveurs, imprimantes et autres périphériques.</p>
                                        <a href="/my/equipment" class="btn btn-sm btn-outline-success">Accéder aux équipements</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fa fa-ticket-alt fa-2x text-primary me-3"></i>
                                    </div>
                                    <div>
                                        <h4>Support technique</h4>
                                        <p>Créez et suivez des tickets d'assistance technique pour résoudre rapidement vos problèmes informatiques.</p>
                                        <a href="/my/tickets" class="btn btn-sm btn-outline-primary">Accéder au support</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fa fa-file-contract fa-2x text-info me-3"></i>
                                    </div>
                                    <div>
                                        <h4>Contrats et services</h4>
                                        <p>Consultez le détail de vos contrats, suivez les services inclus et gérez vos renouvellements.</p>
                                        <a href="/my/contracts" class="btn btn-sm btn-outline-info">Voir les contrats</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fa fa-chart-line fa-2x text-warning me-3"></i>
                                    </div>
                                    <div>
                                        <h4>Tableaux de bord</h4>
                                        <p>Accédez à des statistiques et rapports sur votre infrastructure informatique pour prendre des décisions éclairées.</p>
                                        <a href="/my/dashboard" class="btn btn-sm btn-outline-warning">Voir les tableaux de bord</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour la liste des sites clients -->
    <template id="portal_my_sites" name="My Sites">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mes Sites</t>
            </t>
            
            <t t-if="not sites">
                <div class="alert alert-info text-center" role="alert">
                    Vous n'avez pas de sites enregistrés.
                </div>
            </t>
            
            <t t-if="sites">
                <table class="table table-striped table-hover o_portal_my_doc_table">
                    <thead>
                        <tr class="active">
                            <th>Nom</th>
                            <th>Adresse</th>
                            <th>Téléphone</th>
                            <th>Email</th>
                            <th>Équipements</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="sites" t-as="site">
                            <tr>
                                <td><span t-field="site.name"/></td>
                                <td>
                                    <span t-if="site.street" t-field="site.street"/><br t-if="site.street and (site.zip or site.city)"/>
                                    <t t-if="site.zip or site.city">
                                        <span t-if="site.zip" t-field="site.zip"/> <span t-if="site.city" t-field="site.city"/>
                                    </t>
                                </td>
                                <td><span t-field="site.phone"/></td>
                                <td><span t-field="site.email"/></td>
                                <td>
                                    <t t-set="equipment_count" t-value="request.env['it.equipment'].sudo().search_count([('site_id', '=', site.id)])"/>
                                    <span class="badge rounded-pill bg-info" t-esc="equipment_count"/>
                                </td>
                                <td class="text-end">
                                    <a t-att-href="'/my/sites/%s' % site.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div t-if="pager" class="o_portal_pager text-center">
                    <t t-call="portal.pager"/>
                </div>
            </t>
        </t>
    </template>
    
    <!-- Template pour les détails d'un site -->
    <template id="portal_site_detail" name="Site Details">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <div class="row">
                            <div class="col-md-8">
                                <h3 class="mb-0"><t t-esc="site.name"/></h3>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="/my/sites" class="btn btn-secondary btn-sm">
                                    <i class="fa fa-arrow-left me-1"></i> Retour aux sites
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Informations générales</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 30%">Adresse :</th>
                                            <td>
                                                <address class="mb-0">
                                                    <div t-field="site.street"/>
                                                    <div t-field="site.street2"/>
                                                    <span t-field="site.zip"/> <span t-field="site.city"/>
                                                    <div t-field="site.country_id"/>
                                                </address>
                                            </td>
                                        </tr>
                                        <tr t-if="site.phone">
                                            <th>Téléphone :</th>
                                            <td><span t-field="site.phone"/></td>
                                        </tr>
                                        <tr t-if="site.email">
                                            <th>Email :</th>
                                            <td><span t-field="site.email"/></td>
                                        </tr>
                                        <tr t-if="site.website">
                                            <th>Site web :</th>
                                            <td><span t-field="site.website"/></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Notes</h5>
                                <p t-if="site.comment"><t t-esc="site.comment"/></p>
                                <p t-if="not site.comment" class="text-muted">Aucune note disponible</p>
                            </div>
                        </div>
                        
                        <!-- Équipements associés à ce site -->
                        <h5 class="mt-4">Équipements sur ce site</h5>
                        <t t-if="not equipment">
                            <div class="alert alert-info">
                                Aucun équipement enregistré sur ce site.
                            </div>
                        </t>
                        <t t-if="equipment">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Référence</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>État</th>
                                            <th>Site Client</th>
                                            <th class="text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="equipment" t-as="equip">
                                            <td><span t-field="equip.reference"/></td>
                                            <td><span t-field="equip.name"/></td>
                                            <td><span t-field="equip.type_id.name"/></td>
                                            <td>
                                                <span t-if="equip.state == 'draft'" class="badge bg-secondary">Brouillon</span>
                                                <span t-elif="equip.state == 'in_stock'" class="badge bg-info">En stock</span>
                                                <span t-elif="equip.state == 'installed'" class="badge bg-success">Installé</span>
                                                <span t-elif="equip.state == 'maintenance'" class="badge bg-warning">En maintenance</span>
                                                <span t-elif="equip.state == 'end_of_life'" class="badge bg-danger">Fin de vie</span>
                                            </td>
                                            <td><span t-field="equip.site_id.name"/></td>
                                            <td class="text-end">
                                                <a t-att-href="'/my/equipment/%s' % equip.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </t>
                        
                        <!-- Affichage des incidents liés s'ils existent -->
                        <div t-if="equipment._fields.get('incident_ids') and equipment.incident_ids" class="mt-4">
                            <h5 class="mb-3 border-bottom pb-2">Incidents récents</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Référence</th>
                                            <th>Description</th>
                                            <th>Date</th>
                                            <th>État</th>
                                            <th class="text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="equipment.incident_ids" t-as="incident">
                                            <td><t t-esc="incident.name"/></td>
                                            <td><t t-esc="incident.description"/></td>
                                            <td><t t-esc="incident.date_reported"/></td>
                                            <td>
                                                <span t-attf-class="badge bg-{{
                                                    'success' if incident.state == 'resolved'
                                                    else 'warning' if incident.state == 'in_progress'
                                                    else 'danger' if incident.state == 'blocked'
                                                    else 'info'
                                                }}">
                                                    <t t-esc="incident.state"/>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <a t-att-href="'/my/incidents/%s' % incident.id" class="btn btn-sm btn-outline-primary">Voir</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Notes et commentaires -->
                        <div t-if="equipment._fields.get('notes') and equipment.notes" class="mt-4">
                            <h5 class="mb-3 border-bottom pb-2">Notes</h5>
                            <div class="p-3 bg-light rounded">
                                <p class="text-pre-wrap mb-0"><t t-esc="equipment.notes"/></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="/my/tickets/add" class="btn btn-primary">
                            <i class="fa fa-ticket-alt me-1"></i> Signaler un problème
                        </a>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour la page de confirmation après soumission d'un ticket -->
    <template id="portal_ticket_thankyou" name="Ticket Submission Confirmation">
        <t t-call="portal.portal_layout">
            <div class="container py-5">
                <div class="card border-success shadow-sm">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x text-success"></i>
                                <i class="fa fa-check fa-stack-1x fa-inverse"></i>
                            </span>
                        </div>
                        <h1 class="display-4 mb-4">Merci pour votre ticket !</h1>
                        <p class="lead mb-4">Votre ticket a été soumis avec succès et porte la référence : <strong><t t-esc="ticket.reference"/></strong></p>
                        <p class="mb-4">Un administrateur a été notifié et prendra en charge votre demande dans les plus brefs délais.</p>
                        <div class="alert alert-info mb-4">
                            <h5 class="alert-heading"><i class="fa fa-info-circle me-2"></i> Information</h5>
                            <p class="mb-0">Vous serez informé(e) par email de l'avancement de votre ticket. Vous pouvez également suivre son statut depuis votre espace client.</p>
                        </div>
                        <div class="mt-4">
                            <a href="/my/tickets" class="btn btn-primary btn-lg me-3">
                                <i class="fa fa-list me-2"></i>Voir tous mes tickets
                            </a>
                            <a t-att-href="'/my/tickets/%s' % ticket.id" class="btn btn-outline-secondary btn-lg">
                                <i class="fa fa-eye me-2"></i>Voir ce ticket
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo> 